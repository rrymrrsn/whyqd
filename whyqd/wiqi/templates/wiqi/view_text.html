{% extends "wrapper.html" %}
{% load humanize %}
{% load mathfilters %}

{% block extrastyles %}
<!--<link rel="stylesheet" href="{{ STATIC_URL }}css/medium-editor.css">-->
{% endblock extrastyles %}

{% block heading %}
<div class="whyqd-header">
    <div class="whyqd-text-black">
        <div class="col-xs-12 col-md-10 col-md-offset-2 whyqd-header-text">
            <h1><div id="title">
            {% if page_title %}{{ page_title|safe }}{% endif %}
            </div></h1>
            <h2><small><div id="subtitle">
            {% if wiqi_object.stack %}{{ wiqi_object.stack.subtitle|safe }}{% else %}{{ wiqi_object.subtitle|safe }}{% endif %}
            </div></small></h2>
        </div>
    </div>
</div>
{% endblock heading %}

{% block content %}
<div class="whyqd-content col-xs-12 col-md-10 col-md-offset-1">
    <div class="row" id="content">
    {% if diff_wiqis %}{{ diff_wiqis|safe }}{% else %}{{ wiqi_object.htmlresponse|safe }}{% endif %}
    </div>
    <p>&nbsp;</p>
    <p>&nbsp;</p>
    <div class="row" id="pagenav">
        <div class="col-sm-2 col-md-3">
            {% if wiqi_object.previous_wiqi %}
                <a href="{{ wiqi_object.previous_wiqi.get_url }}">Previous</a>
            {% endif %}
        </div>
        <div class="col-sm-4 col-md-6">
            {% if wiqi_object.next_wiqi %}
                <div class="row" id="nextpage">
                {% if can_read_next == "open" %}
                    <p><a href="{{ next_wiqi.get_url }}">Next chapter</a></p>
                {% elif not request.user.is_authenticated %}
                    <form action="{% url 'facebook_connect' %}?next={{ next_wiqi.get_url }}&facebook_login=1" method="post">
                        {% csrf_token %}
                        <input type="hidden" value="1" name="connect" />
                        <input type="hidden" value="{{ next_wiqi.get_url }}" name="next" />
                        <input type="hidden" value="{{ next_wiqi.get_url }}" name="register_next" />
                        <input type="hidden" value="{{ request.path }}" name="error_next" />
                        <a onclick="F.connect(this.parentNode); return false;" href="javascript:void(0);">
                            Login to read next chapter</a>{% if next_wiqi.price %} (purchase price increases to
                            {% if request.user.is_authenticated and request.user.current_price > next_wiqi.price %}
                            {{ request.user.current_price }}{% else %}{{ next_wiqi.price }}{% endif %}{% endif %})
                    </form>
                {% else %}
                    <p>{% if can_read_next != "own" %}<a href="{{ next_wiqi.get_url }}">Next chapter</a>{% endif %}
                    {% if can_read_next == "login" %}
                        {% if wiqi_object.price %}{% if request.user.is_authenticated and request.user.current_price < next_wiqi.price %}
                        (purchase price increases to &pound;{{ next_wiqi.price }}){% endif %}{% endif %}
                    {% elif can_read_next == "borrowed" %} before {{ request.user.deadline|naturalday:"l j E Y" }}.
                    {% elif can_read_next == "own" %}This isn't the end. {{ novel_title }} continues for owners.
                    {% endif %}</p>
                {% endif %}
                </div>
                <div class="row" id="buynow">
                    {% if wiqi_object.price and can_read_next != "owns" and can_read_next != "borrowed" %}
                    <form action="{% url 'buy_novel' %}" method="POST">
                        {% csrf_token %}
                        <input type="hidden" value="{% if request.user.is_authenticated and request.user.current_price > wiqi_object.price %}
                            {{ request.user.current_price|mul:100|floatformat:"0" }}
                        {% else %}
                            {{ wiqi_object.price|mul:100|floatformat:"0" }}{% endif %}"
                                id="stripePrice" name="stripePrice" />
                        <input type="hidden" value="{% url 'novel_settings' %}" name="stripeSettings" id="stripeSettings" />
                        <input type="hidden" value="{% url 'buy_novel' %}" name="stripeBuy" id="stripeBuy" />
                        <input type="hidden" value="{{ next_wiqi.get_url }}" name="stripeNext" id="stripeNext" />
                    </form>
                    <button id="stripeButton" class="btn btn-default" >Buy for &pound;
                            {% if request.user.is_authenticated and request.user.current_price > wiqi_object.price %}
                            {{ request.user.current_price }}{% else %}{{ wiqi_object.price }}{% endif %}</button>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock content %}

{% block extrascripts %}
<script src="{{ STATIC_URL }}js/jquery.whyqd.view.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/bootstrap.min.js"></script>
<script src="https://checkout.stripe.com/checkout.js"></script>
<script>
    $(document).ready(function() {
        if ($('#stripeButton').length > 0) {
            $.ajax({
                url: $('#stripeSettings').val()
                }).done(function(data) {
                    ns = data.settings;
                    var handler = StripeCheckout.configure({
                        key: ns.stripe_key,
                        image: '/square-image.png',
                        name: ns.novel_title,
                        email: ns.user_email,
                        currency: "GBP",
                        token: function(token) {
                            // http://stackoverflow.com/a/22461608
                            // You can access the token ID with `token.id`
                            if (!ns.user_email) {
                                ns.user_email = token.email;
                            }
                            $.ajax({
                                url: $('#stripeBuy').val(),
                                type: 'post',
                                data: {
                                    stripeToken: token.id,
                                    stripeDescription: ns.description,
                                    stripePrice: ns.price,
                                    stripeEmails: ns.user_email,
                                    selfPurchase: true // Buying for own use
                                },
                                success: function(data) {
                                    if (data.response == 'success') {
                                        var next_page = '<p><a href="' + $('#stripeNext').val() +
                                                        '">Next chapter</a></p>';
                                        $('#nextpage').html(next_page);
                                        $('#buynow').remove();
                                        if (data.registered) {
                                            $('#nextpage').after(
                                                '<div class="alert alert-success alert-dismissable">'+
                                                '<button type="button" class="close" ' + 
                                                'data-dismiss="alert" aria-hidden="true">' + '&times;' + 
                                                '</button>' + 
                                                '<p><strong>Thank you</strong>, your purchase has been successful.</p>' +
                                                '<p>You can continue reading ' + ns.novel_title + ' online, or ' +
                                                '<a href="' + data.link + '" class="alert-link"> download an ebook ' +
                                                'version</a>. You could even share a copy with your friends.</p>' +
                                                '</div>');
                                        }
                                        else {
                                            // http://stackoverflow.com/a/506004
                                            window.location.href = data.link;
                                        }
                                    }
                                    else {
                                        $('#stripeButton').after(
                                            '<div class="alert alert-danger alert-dismissable">'+
                                                '<button type="button" class="close" ' + 
                                                    'data-dismiss="alert" aria-hidden="true">' + '&times;' + 
                                                '</button>' + 
                                                '<strong>Sorry</strong>, something went wrong.' +
                                                'You have not been charged. Please try again.' +
                                             '</div>');
                                    }
                                },
                                error: function(data) {
                                    $('#stripeButton').after(
                                        '<div class="alert alert-danger alert-dismissable">'+
                                            '<button type="button" class="close" ' + 
                                                'data-dismiss="alert" aria-hidden="true">' + '&times;' + 
                                            '</button>' + 
                                            '<strong>Sorry</strong>, something went wrong.' +
                                            'You have not been charged. Please try again.' +
                                         '</div>');
                                }
                              }); // end ajax call
                        }
                    });
                    document.getElementById('stripeButton').addEventListener('click', function(e) {
                        ns.price = $('#stripePrice').val().trim();
                        ns.description = "Single purchase of " + ns.novel_title;
                        // Open Checkout with further options
                        handler.open({
                          description: ns.description,
                          amount: ns.price
                        });
                        e.preventDefault();
                    });
                });
        }
    });
</script>
{% endblock extrascripts %}